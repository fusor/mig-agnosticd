# Prerequisites

Required versions of products used:

| Product         | Versions    |
| -----------     | ----------- |
| OpenShift 3.x   | v3.9+       |
| OpenShift 4.x   | v4.2+       |

Additionally, temporary object storage will be required perform a migration.  This can be provided through: [AWS S3](https://aws.amazon.com/s3/), [Noobaa](https://www.noobaa.io/), or [Minio](https://min.io/).

## Base requirements

* A computer with access to the Internet :-)
* SSH client (for Microsoft Windows users [Putty](https://www.putty.org/) is recommended)
* Firefox 17 or higher, or Chromium / Chrome
* oc client [Download from try.openshift.com](http://try.openshift.com)

## Accessing the Bastion Host & Client VM

For certain tasks in the lab, you will need to ssh into bastion host.  Remember that login details are presented by GuidGrabber.

e.g:

![SSH Details GuidGrabber](screenshots/ssh-details-gg.png)

For *sshing* in the bastion host you can use your favorite ssh-client.

~~~sh
ssh lab-user@bastion.GUID.DOMAIN

e.g: ssh lab-user@bastion.d5fe.events.opentlc.com
~~~

At this point you should be logged in to the bastion host and you should have the information for both environments defined by the GuidGrabber.



<a id="markdown-verifications" name="verifications"></a>
## Verifications

### Verify 3.11 environment

1. Log into the 3.11 environment
```bash
$ oc login https://master1.GUID.DOMAIN -u admin -p r3dh4t1!
The server uses a certificate signed by an unknown authority.
You can bypass the certificate check, but any data you send to the server could be intercepted by others.
Use insecure connections? (y/n): y
```
1. Verify that the `migration-operator` deployment is running in `mig` namespace and healthy
```bash
$ oc get deployment migration-operator -n mig
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
migration-operator   1         1         1            1           5m
```

1. Verify that Velero is now running on the source in the `mig` namespace
```
$ oc get pods -n mig | grep velero
velero-7559946c5c-mh5sp               1/1     Running   0          2m
```


### Verify 4.2 environment

1. Set KUBECONFIG to point to 4.1 environment (Assumes you didn't change `output_dir` var in `mig-agnosticd`)
```bash
$ export KUBECONFIG=~/.agnosticd/dymurray-ocp4-cluster/ocp4-workshop_dymurray-ocp4_kubeconfig
```

1. Verify that you see the below pods now running in `mig` namespace, we are looking for pods of `controller-manager`, `velero`, and `migration-ui`
```bash
$ oc get pods -n mig
NAME                                 READY   STATUS      RESTARTS   AGE
migration-operator-437w4jd-88sf      1/1     Running     0          2m
controller-manager-79bf7cd7d-99sbr   1/1     Running     0          2m
migration-ui-6d84bb9879-w52qx        1/1     Running     0          2m
restic-6lhnp                         1/1     Running     0          2m
restic-c72gl                         1/1     Running     0          2m
restic-xf4z2                         1/1     Running     0          2m
velero-6bf58f4f88-6cpw8              1/1     Running     0          2m
```

1. Determine the route of `mig-ui`, we will use this later to enable a CORS header on the OCP 3.x side.
```bash
$ oc get routes migration -n mig -o jsonpath='{.spec.host}'
migration-mig.apps.cluster-dymurray-ocp4.dymurray-ocp4.mg.example.com
```

## CORS Configuration

CAM's UI is served out of the cluster
behind its own route, there are 3 distinct origins at play:

* The UI - (Ex: https://mig-ui-mig.apps.examplecluster.com)
* The OAuth Server - (Ex: https://openshift-authentication-openshift-authentication.apps.examplecluster.com)
* The API Server - (Ex: https://api.examplecluster.com:6443)

When the UI is served to the browser through it's route, the browser recognizes
its origin, and **blocks AJAX requests to alternative origins**. This is called
[Cross-Origin Resource Sharing (CORS)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS),
and it's a deliberate browser security measure.

The full description of CORS is linked above, but without configuring the non-UI
origin servers, the requests will be blocked. To enable these requests,
the UI's origin should be whitelisted in a `corsAllowedOrigins` list for each
alternative origin. The servers should recognize this list and inspect the
origin of incoming requests. If the origin matches one of the CORS whitelisted
origins (the UI), there are a set of headers that are returned in the response
that inform the browser the CORS request is accepted and valid.

Additionally, for the same reasons described above, any requests that the UI
may make to source 3.x clusters will also have to be whitelisted by configuring
the same field in the 3.x cluster master-config.yaml. This causes the 3.x API
servers to accept the CORS requests incoming from the UI that was served out
of its OCP4 cluster's route.

1. SSH into bastion Host.
```bash
$ ssh lab-user@bastion.GUID.DOMAIN
```
2. Run the following playbook to enable the proper CORS headers on the source v3.11 cluster.  Be sure to provide the GUIDs for the 3.11 and 4.2 environments.
```
USER=<USER> GUID_3=<GUID> GUID_4=<GUID> domain=<DOMAIN> ansible-playbook cors.yaml
```
e.g:
```
USER=lab-user GUID_3=9ey2 GUID_4=cy3s domain=events.opentlc.com ansible-playbook cors.yaml
```

## Prepare to use mig-ui from OCP 4.1 Cluster in your Browser
1. To visit the ui, look at the route on the OCP 4.1 Cluster
```bash
$ oc get routes migration -n mig -o jsonpath='{.spec.host}'
migration-mig.apps.cluster-dymurray-ocp4.dymurray-ocp4.mg.example.com
```

1. For this example we'd visit the below from our browser:
  * https://migration-mig.apps.cluster-dymurray-ocp4.dymurray-ocp4.mg.example.com

### Accept certificates on source and destination clusters

1. Before you can login you will need to accept the certificates with your
   browser on both the source and destination cluster. To do this:
  * Visit the link displayed by the webui for `.well-known/oauth-authorization-server`
    * OCP 4.1: https://api.cluster-dymurray-ocp4.dymurray-ocp4.mg.example.com:6443/.well-known/oauth-authorization-server
    * OCP 3.11 https://master.dymurray-ocp3.mg.dog8code.com/.well-known/oauth-authorization-server
  * Refresh the page
  * Get redirected to login page
1. Login with your credentials for the cluster.
  * You can find your credentials from the output directory of agnosticd
  * For example:
```
$ cat ~/.agnosticd/dymurray-ocp4/ocp4-workshop_dymurray-ocp4_kubeadmin-password
de8uJb-UdwTd-P6REei-JJL3X
```
  * I would login as:
    * Username:    `kubeadmin`
    * Password:    `de8uJb-UdwTd-P6REei-JJL3X`
1. We also need to accept the certificates from the OCP 3.11 cluster
  * Visit the webui for OCP 3.11 console, for example: https://master.dymurray-ocp3.mg.example.com
  * Login with the credentials from agnosticd:
    * Username: `opentlc-mgr`
    * Password: `r3dh4t1!`
