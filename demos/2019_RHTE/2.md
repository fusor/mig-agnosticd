### 5.1 Control Plane Migration Assistance (CPMA)

Control Plane Migration Assistant ([CPMA](https://github.com/fusor/cpma)) is a Command Line interface to help as much as possible users migrating an OpenShift 3.7+ control plane configuration to an OpenShift 4.x. The utility provides Custom Resource (CR) manifests and reports informing users which aspects of configuration can and cannot be migrated.

#### 5.1.1 Background

OpenShift Container Platform (OCP) version 3 uses Ansible's openshift-ansible modules to allow for extensive configuration.

Meanwhile OCP 4.x uses openshift-installer which integrates with supported clouds for deployment, openshift-installer is a Day-1 operation and relies on [Operators](https://www.openshift.com/learn/topics/operators) to install and configure the cluster.

Many of the installation options available during install time in OpenShift 3 are configurable by the user as Day-2 operations in OpenShift 4.
In many cases this is done by writing CRs for operators which affect the configuration changes.

Since there is no direct upgrade path from OCP 3 to OCP 4, the goal of CPMA is to ease the transition between the 2 OCP versions involved.

#### 5.1.2 Goals

Bring the target Cluster to be as close as possible from the source cluster with the use of CR Manifests and report which configuration aspects can and cannot be migrated.
The tool effectively provides confidence information about each processed options to explain what is supported, fully, partially or not.
The generated CR Manifests can be applied to an OpenShift 4 cluster as Day-2 operations.

### 5.1.3 Non-Goals

Applying the CRs to the OpenShift 4 cluster directly is currently not an intended feature for this utility.
The user must review the output CRs and filter the desired ones to be applied to a targeted OCP 4 cluster.
Migrating workloads are not to be done with CPMA, please use the appropriate migration tool for this purpose.

#### 5.1.4 Operation Overview

The purpose of the CPMA tool is to assist an administrator to migrate the control plane of an OpenShift cluster from version 3.7+ to its next major OpenShift version 4.x.
For that purpose CPMA sources information from:
- Cluster Configuration files:
  - Master Node:
    - Master configuration file - Usually /etc/origin/master/master-config.yaml
    - CRIO configuration file - Usually /etc/crio/crio.conf
    - ETC configuration file - Usually /etc/etcd/etcd.conf
    - Image Registries file - Usually /etc/containers/registries.conf
    - Dependent configuration files:
      - Password files
        - HTPasswd, etc.
      - Configmaps
      - Secrets
- APIs
  - Kubernetes
  - Openshift

Configuration files are processed to generate equivalent Custom Resource manifest files which can then to be consumed by OCP 4.x Operators.
During that process, every parameter that is analyzed is ported when compatible to its equivalent.
A feature fully supported or not means there is a direct or not equivalent in OCP 4.
A partially supported parameter indicates the feature is note entirely equivalent.
The reason for the latter is because some features are deprecated or used differently in OCP 4.
OCP 3 and 4 approach configuration management completely differently across.
Therefore itâ€™s expected the tool cannot port all features across.

For more information about CPMA coverage please see [docs](./docs).

CPMA uses an ETL pattern to process the configuration files and query APIs which produce the output in two different forms:
- Custom Resource Manifest files in YAML format
- A report file (by default report.json) is produced by the reporting process

The user can then review the new configuration from the generated manifests and must also use the reports as a guide how to leverage the CRs to apply configuration to a newly installed OpenShift 4 cluster. The reviewed configuration can then be used to update a targeted OpenShift cluster.

Let's go ahead a run CPMA against our source 3.11 cluster.  CPMA has already been installed on the bastion host.

1. SSH into bastion Host.
```bash
$ ssh lab-user@bastion.GUID.DOMAIN
```

2. Let's look at the help page for CPMA
```bash
$ cpma --help
```
